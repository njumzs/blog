---
title: ssh的密钥机制
permalink: ssh-key
tags:
	- ssh
date: 2016-03-19
---

一直对ssh公钥私钥机制不是很了解，今天研究了下，做个记录。
首先我们知道ssh不是明文传输的，所以才需要加密。ssh登陆的准备工作可以分成俩个阶段。本次会话的密钥生成和认证过程。因为在时序上，认证过程晚于会话密钥的生成，因此先讲会话密钥的生成。

## 会话密钥生成

服务器每次sshd服务启动时，会主动去查找/etc/ssh/ssh_host*目录，如果没有公钥私钥文件，就会生成新的密钥对，这里的密钥暂且称为key1，当sshd收到客户端的连接请求时，服务器会将key1_pub发送给客户端，此处是明码传送，反正公钥就是在网络上分发给别人用的嘛，这里也不需要担心什么。同时:

1. 服务器生成会话id，发送给客户端。
2. 客户端生成会话密钥key2，设为 key2，并计算 r = id xor key2_pub。
3. 客户端将 r 用key1_pub进行加密，结果发送给服务器。
4. 服务器用 key1_pri进行解密，获得 r。
5. 服务器进行 r xor id 的运算，获得 key2_pub。
6. 至此服务器和客户端都知道了会话密钥key2_pub，以后的传输都将被key2_pub加密。

可以看到，key2_pub传输是加密的。

## 认证过程

认证过程可以分为俩种，基于密码的认证和基于密钥机制的认证，密码认证很直观，每次客户端连接sshd服务器都要输入密码口令，这样搞不是很方便，单单每次输入密码就很麻烦，再者，比如一个账号分发给多人登陆每改一次密码就要通知多个人。更方便的做法是客户端生成一个公私钥对，这里且命名为key3，在登陆前将key3的公钥key3_pub上传到要登陆的远程sshd服务器，之后:

1. 服务器生成一个随机数 x，并用 key3_pub加密后生成结果 f(x)，发送给客户端
2. 客户端使用 key3_pri 解密 f(x) 得到 x
3. 客户端计算 key2_pri + x 的 md5 值 n(key2_pri+x)，并发给服务器
4. 服务器计算 key2_pub + x 的 md5 值 m(key2_pub+x)
5. 服务器比较 m(key2_pub+x) 和 n(key2_pri+x)，两者相同则认证成功

因此，认证过程的密钥和本次会话密钥是不一样的，所以一个基于密钥认证的ssh过程，涉及到三个不同的密钥对。最后的结果是，服务器持有key1_pri和key2_pub，客户端持有key2_pri和key1_pub，是不一样的，所以叫作非对称式密钥系统。同时，会话密钥是客户端随机运算产生于本次连接的，因此是暂时性的，不同的连接，会话密钥可能是不同的，此后的数据传输阶段由key1，key2参与，双向的过程都遵循公钥加密，私钥解密的原则。至于认证过程的密钥key_3，如其名，仅仅是参与认证的开始阶段而已。

## 参考

1. [鸟哥的linux私房菜服务篇](http://linux.vbird.org/linux_server/0310telnetssh.php)
